#!/bin/bash
# =============================================
# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è backend –Ω–∞ production —Å–µ—Ä–≤–µ—Ä
# =============================================

echo "üöÄ –î–µ–ø–ª–æ–π SalaryMonitor Backend..."

# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üì¶ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 stop salary-monitor-backend || true

# 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
git pull origin main

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm ci --production

# 4. –°–±–æ—Ä–∫–∞
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# 5. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
echo "üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î..."
# node scripts/migrate.js

# 6. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ PM2
echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
pm2 start ecosystem.config.js --env production
pm2 save

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üìä –°—Ç–∞—Ç—É—Å:"
pm2 status

echo ""
echo "üìù –õ–æ–≥–∏:"
echo "   pm2 logs salary-monitor-backend"
echo "   pm2 monit"
